
<div id="app">
	<upload-item></upload-item>
	<upload-list></upload-list>
</div>


{{#section 'body_js'}}
<script type="text/javascript">

	// TODO: Use Bootstrap for Vue

    // TODO: Use a build system (babelify/vuefy/browserify/watchify) to generate/bundle the client JS

	// TODO: Use this EventBus Use Vuex/Redux or simple global state
	let bus = new Vue();

	// TODO: Add Vue transition animations

	Vue.component('upload-item', {
		template: `
		<div>
			<h1>Upload a new file</h1>
			<form>
				<div>
					<input type="file" v-on:change.prevent="$event.target.files.length ? file = $event.target.files[0] : null" />
					<br>
					<label for="file_name">Give the file a name:</label>
					<input type="text" name="file_name" v-model.trim="name" />
				</div>
				<br>
				<div>
					<button type="button" v-on:click.prevent="onUpload" v-bind:disabled="!file">Upload</button>
				</div>
			</form>
			<hr>
		</div>
		`,
		data() {
			return {
				name: "Example name",
				file: null
			}
		},
		methods: {
			onUpload() {
				var data = new FormData();
				// This is the raw file that was selected
				data.append('file', this.file);
				// This is the name of the FileUpload
				data.append('name', this.name);

				fetch('/api/fileupload/create', {
					method: 'POST',
					body: data,
					credentials: 'same-origin',
					cache: 'no-cache',
				})
					.then(r => {
						if (!r.ok) return Promise.reject('failed');
						return r.json();
					})
					.then(data => {
						var item = data.item;

						// add to list - the components are not child/parent
						// so a bus can be used (or Vuex/redux if necessary)
						bus.$emit("upload-list:add", item);
					})
					.catch(err => {
						alert('Failed to add new file-upload - ' + error);
					});
			}
		}
	});

	Vue.component('upload-list-item', {
  		props: ['item'],
  		template: `
			<li enter-active-class="animated tada" leave-active-class="animated bounceOutRight">
				<a v-bind:href="item.file.url" download>\{{ item.name }}</a>
			     - <a href="" v-on:click.prevent="onRemove(item)">Delete</a>
			</li>
			`,
		methods: {
			onRemove(item) {
				fetch(`/api/fileupload/${item.id}/remove`, {
					credentials: 'same-origin',
					cache: 'no-cache',
				})
					.then(r => {
						if (!r.ok) return Promise.reject('failed');
						return r.json();
					})
					.then(data => {
						var success = !!data.success;
						if (!success) {
							return Promise.reject('failed');
						}
						
						// remove from list
						this.$emit("upload-list:remove", item);
					})
					.catch(function (error) {
						alert('Failed to remove file-upload - ' + error);
					});
			}
		}
	});

	Vue.component('upload-list', {
		template:`
		<div>
			<h2>Uploaded File List:</h2>
			<ul>
				<transition appear appear-active-class="animated tada">
					<upload-list-item
					v-for="item of items" 
					v-bind:item="item" 
					v-on:upload-list:remove="removeFromList">
				</upload-list-item>
				</transition>
			</ul>
		</div>
		`,
		data() {
			return {
				items: []
			}
		},
		methods: {
			addToList(item) {
				// mutate
				this.items.unshift(item);
				
				// immutable ?
				//this.items = [item, ...this.items];
			},
			removeFromList(item) {
				// mutate
				const index = this.items.indexOf(item);
    			if (index !== -1) {
        			this.items.splice(index, 1);
    			}

				// immutable ?
				//this.items = this.items.filter(el => el !== item);
			}
		},
		mounted() {
			bus.$on("upload-list:add", item => {
				this.addToList(item);
			});

			// load all current file-uploads
			fetch('/api/fileupload/list', {
				credentials: 'same-origin',
				cache: 'no-cache',
			})
				.then(r => {
					if (!r.ok) return Promise.reject('failed');
					return r.json();
				})
				.then(data => {
					var items = data.items;
					items.forEach(item => this.addToList(item));
				})
				.catch(function (error) {
					alert('Failed to list file-uploads - ' + error);
				});
		}
	});

	// https://vuejs.org/v2/guide/ 
	// https://www.smashingmagazine.com/2018/02/jquery-vue-javascript/ 
	new Vue({
		el: '#app',
	});

</script>
{{/section}}

{{#section 'head_css'}}
<link href="https://cdn.jsdelivr.net/npm/animate.css@3.5.1" rel="stylesheet" type="text/css">
{{/section}}
